---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ContentLayout from '@/layouts/ContentLayout.astro';
import { SITE } from '@/site.config';
import { getCollection } from 'astro:content';
import groupPostsBy from '@/utils/groupPostsBy';
import formatMonthDay from '@/utils/formatMonthDay';
import { slugifyStr } from '@/utils/slugify';

if (!SITE.showArchives) {
  return Astro.redirect('/404');
}

const posts = await getCollection('blog', ({ data }) => !data.draft);
---

<BaseLayout title='archives'>
  <ContentLayout pageTitle='Archives'>
    <div class='mt-6 space-y-12'>
      {
        Object.entries(
          groupPostsBy(posts, post => post.data.pubDatetime.getFullYear()),
        )
          .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
          .map(([year, yearGroup]) => (
            <section>
              <h2 class='mb-1 text-lg font-medium'>
                {year}
                <sup class='text-xs'>{yearGroup.length}</sup>
              </h2>
              <ul class='space-y-3'>
                {yearGroup
                  .sort(
                    (a, b) =>
                      Math.floor(
                        new Date(b.data.pubDatetime).getTime() / 1000,
                      ) -
                      Math.floor(new Date(a.data.pubDatetime).getTime() / 1000),
                  )
                  .map(post => (
                    <li class='flex items-baseline gap-4'>
                      <time class='shrink-0 text-sm text-foreground-muted tabular-nums'>
                        {formatMonthDay(post.data.pubDatetime)}
                      </time>
                      <a
                        href={`/posts/${post.id}`}
                        class='underline decoration-1 underline-offset-4 transition-colors hover:text-foreground-secondary/90'
                      >
                        <span transition:name={slugifyStr(post.data.title)}>
                          {post.data.title}
                        </span>
                      </a>
                    </li>
                  ))}
              </ul>
            </section>
          ))
      }
    </div>
  </ContentLayout>
</BaseLayout>
